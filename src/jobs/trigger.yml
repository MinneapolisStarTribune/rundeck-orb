description: This job will fire a basic unparameterized request to your Rundeck API to trigger a job.

parameters:
  baseurl:
    description: The base URL of your Rundeck API. This should not end in a slash.
    type: string
    default: "https://rundeck.example.org/api"
  jobid:
    description: The unique identifier for the job to trigger.
    type: string
    default: "abcdef01-2345-6789-abcd-ef0123456789"
  authtoken:
    description: The API token generated by Rundeck.
    type: string
    default: "abcdef01-2345-6789-abcd-ef0123456789"

docker:
  - image: cimg/base:stable
resource_class: small

steps:
  - run:
      name: Trigger Rundeck
      environment:
        AUTHTKN: <<parameters.authtoken>>
        BASEURL: <<parameters.baseurl>>
      command: |
        APIOUT=$(mktemp)
        STATUSOUT=$(mktemp)
        if [[ "${AUTHTKN}" == "abcdef01-2345-6789-abcd-ef0123456789" ]]
        then
          if [[ "${RUNDECK_AUTH_TOKEN}x" == "x" ]]
          then
            echo "Rundeck authentication token not provided, and not present in environment."
            exit 1
          else
            echo "Using Rundeck authentication token from environment."
            AUTHTKN="${RUNDECK_AUTH_TOKEN}"
          fi
        fi
        if [[ "${BASEURL}" == "https://rundeck.example.org/api" ]]
        then
          if [[ "${RUNDECK_BASE_URL}x" == "x" ]]
          then
            echo "Rundeck base URL not provided, and not present in environment."
            exit 1
          else
            echo "Using Rundeck base URL from environment."
            BASEURL="${RUNDECK_BASE_URL}"
          fi
        fi
        curl -LSg -X POST -o ${APIOUT} -w '%{http_code}\n' \
          --header 'Accept: application/json' \
          --header "X-Rundeck-Auth-Token: ${AUTHTKN}" \
          --data-urlencode "option.cibranch=${CIRCLE_BRANCH}" \
          --data-urlencode "option.cibuildnum=${CIRCLE_BUILDNUM}" \
          --data-urlencode "option.cicommit=${CIRCLE_SHA1}" \
          --data-urlencode "option.cireponame=${CIRCLE_PROJECT_REPONAME}" \
          --data-urlencode "option.cirepoowner=${CIRCLE_PROJECT_USERNAME}" \
          --data-urlencode "option.cirepourl=${CIRCLE_REPOSITORY_URL}" \
          --data-urlencode "option.ciprurl=${CIRCLE_PULL_REQUEST}" \
          --data-urlencode "option.citag=${CIRCLE_TAG}" \
          --data-urlencode "option.ciuser=${CIRCLE_USERNAME}" \
          "${BASEURL}/18/job/<<parameters.jobid>>/run" \
          > ${STATUSOUT}
        if (( $(cat ${STATUSOUT}) > 399 ))
        then
          echo "Request failed with status $(cat ${STATUSOUT})"
          jq . ${APIOUT}
          exit 1
        fi
        JOBSTATUS=$(jq -r '.status // "unknown"' ${APIOUT})
        if [[ "${JOBSTATUS}" == "running" ]]
        then
          echo "Rundeck job is running: $( jq -r .permalink ${APIOUT})"
        else
          echo "Rundeck job is ${JOBSTATUS}."
        fi
